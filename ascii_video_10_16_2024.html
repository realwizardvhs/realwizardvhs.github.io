<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ASCII Art GIF</title>
    <!-- Include Bootstrap CSS and JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.2.0/p5.min.js"></script>
    <link rel="stylesheet" href="style.css" type="text/css">
</head>
<body>
    <!-- Your HTML structure -->
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div id="navbar"></div>
            </div>  
        </div>
        <div class="row">
            <div class="col-12 text-center">
                <div id="sketch-controls">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 text-center">
                <div id="sketch-holder"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 text-center">
                <h1 id="art_title"></h1>
                <p id="art_date"></p>
                <p id="art-description"></p>
            </div>
        </div>
    </div>

    <!-- Include your navbar.js if needed -->
    <script src="navbar.js"></script>
    <!-- Your p5.js sketch -->
    <script>
        let gifs = [
            ["anime",4],
            ["bike",2],
            ["car",1],
            ["cat",2],
            ["cyberpunk",5],
            ["effect",5],
            ["falling",3],
            ["guitar",1],
            ["gun_spin",1],
            ["horse",1],
            ["optical_illusion",1],
            ["piano",1],
            ["retro",9],
            ["spinning_record",1],
            ["train",2],
            ["wizard",1],
        ]
        let canvas;
        let font;
        let img;
        let gifFrames = [];
        let currentFrame = 0;
        let asciiCharacters = "+*-=██*"; // Set of characters used to create structure-based ASCII art.
        let maxFontSize = 8;
    
        let buttons = []
        function preload() {
            font = loadFont('Inconsolata.otf'); // Provide path to your font file here.
            // Removed img loading from here
        }
    
        function setup() {
            canvas = createCanvas(100, 100); // Create a default canvas, will resize later
            canvas.parent("sketch-holder");
            frameRate(20); // Control the speed of GIF playback.
            textSize(maxFontSize); // Use maximum font size value
            textAlign(LEFT, TOP);

            console.log(gifs)
            let controls = document.getElementById("sketch-controls");
            for (let i = 0; i < gifs.length; i++) {
                let num_buttons = gifs[i][1]
                for(let j = 1; j <= num_buttons; j++){
                    let button = createButton(gifs[i][0] + " " + j);
                    button.parent(controls);
                    button.mousePressed(() => {
                        img = loadImage("gifs/" + gifs[i][0] + "_" + j + ".gif", resetSketch);
                        document.getElementById("art_title").innerHTML = gifs[i][0] + " " + j;
                        document.getElementById("art_date").innerHTML = "10/16/2024";
                        document.getElementById("art-description").innerHTML = "This is a description of the art piece.";
                    });
                    buttons.push(button)
                }
            }

            //load train_2.gif by default
            img = loadImage("gifs/train_2.gif", resetSketch);
            document.getElementById("art_title").innerHTML = "train 2";
            document.getElementById("art_date").innerHTML = "10/16/2024";
            document.getElementById("art-description").innerHTML = "This is a description of the art piece.";

        }
    
        function resetSketch() {
            gifFrames = [];
            currentFrame = 0; // Reset current frame
    
            // Make sure image is loaded before extracting frames
            if (img) {
                loadGifFrames();
                // Resize canvas only if frames are loaded successfully
                if (gifFrames.length > 0) {
                    let canvasWidth = gifFrames[0].width * maxFontSize;
                    let canvasHeight = gifFrames[0].height * maxFontSize;
                    resizeCanvas(canvasWidth, canvasHeight);
                }
            }
        }
    
        function loadGifFrames() {
            // Resize and store each frame of the GIF in an array
            let numFrames = img.numFrames();
            gifFrames = [];
            for (let i = 0; i < numFrames; i++) {
                img.setFrame(i);
                let frameCopy = createImage(img.width, img.height);
                frameCopy.copy(img, 0, 0, img.width, img.height, 0, 0, img.width, img.height);
                frameCopy.resize(110, 0); // Resize each frame to 100 pixels wide
                frameCopy.loadPixels();
                gifFrames.push(frameCopy);
            }
        }
    
        function draw() {
            if (gifFrames.length === 0) {
                // Return if frames are not yet loaded
                return;
            }
    
            background(25, 150); // Set a white background with some transparency
    
            let imgFrame = gifFrames[currentFrame];
            imgFrame.loadPixels();
            let textSizeValue = maxFontSize;
    
            textSize(textSizeValue);
            textAlign(LEFT, TOP);
    
            for (let j = 1; j < imgFrame.height - 1; j++) {
                for (let i = 1; i < imgFrame.width - 1; i++) {
                    let pixelIndex = (i + j * imgFrame.width) * 4;
                    let r = imgFrame.pixels[pixelIndex + 0];
                    let g = imgFrame.pixels[pixelIndex + 1];
                    let b = imgFrame.pixels[pixelIndex + 2];
    
                    // Calculate edge detection using Sobel operator
                    let gx = -1 * getBrightness(imgFrame, i - 1, j - 1) + 1 * getBrightness(imgFrame, i + 1, j - 1)
                            - 2 * getBrightness(imgFrame, i - 1, j)     + 2 * getBrightness(imgFrame, i + 1, j)
                            - 1 * getBrightness(imgFrame, i - 1, j + 1) + 1 * getBrightness(imgFrame, i + 1, j + 1);
    
                    let gy = -1 * getBrightness(imgFrame, i - 1, j - 1) - 2 * getBrightness(imgFrame, i, j - 1) - 1 * getBrightness(imgFrame, i + 1, j - 1)
                            + 1 * getBrightness(imgFrame, i - 1, j + 1) + 2 * getBrightness(imgFrame, i, j + 1) + 1 * getBrightness(imgFrame, i + 1, j + 1);
    
                    let edgeValue = sqrt(gx * gx + gy * gy);
    
                    let len = asciiCharacters.length;
                    let charIndex = floor(map(edgeValue, 0, 255, len - 1, 0)); // Map edge value to ASCII density.
                    let asciiChar = asciiCharacters.charAt(charIndex);
    
                    fill(r, g, b);
                    textSize(textSizeValue * 1.5);
                    text(asciiChar, i * textSizeValue, j * textSizeValue); // Draw each character individually to map to a grid.
                }
            }
    
            currentFrame = (currentFrame + 1) % gifFrames.length; // Loop through frames
        }
    
        // Helper function to get the brightness of a pixel at (x, y)
        function getBrightness(img, x, y) {
            let index = (x + y * img.width) * 4;
            let r = img.pixels[index + 0];
            let g = img.pixels[index + 1];
            let b = img.pixels[index + 2];
            return (r + g + b) / 3;
        }
    </script>
    

</body>
</html>
