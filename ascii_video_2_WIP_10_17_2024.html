<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.2.0/p5.min.js"></script>
    <link rel="stylesheet" href="style.css" type="text/css">
    <meta charset="utf-8">
    <title>Sketch</title>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div id="navbar"></div>
            </div>  
        </div>
        <div class="row">
            <div class="col-12 text-center">
                <div id="sketch-holder"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 text-center">
                <div id="sketch-controls">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 text-center">
                <h1 id="art_title"></h1>
                <p id="art_date"></p>
                <p id="art-description"></p>
            </div>
        </div>
    </div>
    

    <script src="navbar.js"></script>
    <script>
        let custom_font
        var canvasTextSize = 8

        let allowed_characters = "#-=+*"
        let characters_by_brightness =  `.-':_,^=;><+!rc*/z?sLTv)J7(|Fi{C}fI31tlu[neoZ5Yxjya]2ESwqkP6h9d4VpOGbUAKXHm8RD#$Bg0MNWQ%&@`

        let canvas_width
        let canvas_height
        let grid_rows
        let grid_columns

        let gif_path = 'gifs/car_1.gif'
        let gif
        let gif_frames = []
        let fps = 8
        let gif_frame_number = 0
        let grid = []

        function preload(){
            custom_font = loadFont("fonts/square.ttf")
            gif = loadImage(gif_path)

        }

        function load_gif_frames(){
            for(let i=0; i<gif.numFrames(); i++){
                gif.setFrame(i)
                gif.loadPixels()
                gif_frames.push(gif.get())

            }
        }

        function getClosestMultipleOf(number, multiple){
            let new_number = number +multiple/2
            new_number = new_number - (new_number % multiple)
            return new_number
        }

        function getBrightness(r, g, b){
            return (r+g+b)/3
        }

        function getBrightnessCharacter(brightness){
            let index = map(brightness, 0, 255, 0, characters_by_brightness.length-1)
            return characters_by_brightness.charAt(index)

        }



        function setup(){
            load_gif_frames()
            canvas_width = gif.width
            canvas_height = gif.height
            gif.resize(200,0)


            grid_columns = canvas_width/canvasTextSize
            grid_rows = canvas_height/canvasTextSize

            canvas = createCanvas(canvas_width, canvas_height)
            canvas.parent("sketch-holder")

            pixelDensity(1)

            textFont(custom_font)
            

            for(let row = 0; row < grid_rows; row++){
                let current_row = []
                for(let col = 0; col < grid_columns; col++){
                    current_row.push(get_random_character())
                }
                grid.push(current_row)
            }
        }

        function get_random_character(){
            let random_index = Math.floor(Math.random() * allowed_characters.length)
            return allowed_characters[random_index]
        }

        function draw_character_rectangle(x, y, character,r,g,b){
            let x_pos = x * canvasTextSize
            let y_pos = y * canvasTextSize

           // rect(x_pos, y_pos, canvasTextSize, canvasTextSize)
           fill(r,g,b)
            textSize(canvasTextSize)
            text(character, x_pos, y_pos+canvasTextSize)
        }

        function draw_grid(){
            let frame = gif_frames[gif_frame_number]
            frame.loadPixels()
            for(let row = 0; row < grid_rows; row++){
                for(let col = 0; col < grid_columns; col++){
                    let x = col * canvasTextSize
                    let y = row * canvasTextSize

                    let pixel_index = (x + y * canvas_width) * 4
                    let r = frame.pixels[pixel_index]
                    let g = frame.pixels[pixel_index + 1]
                    let b = frame.pixels[pixel_index + 2]

                    let brightness = getBrightness(r,g,b)
                    let character = getBrightnessCharacter(brightness)
                    draw_character_rectangle(col, row, character, r, g, b)
                }
            }
        }

        function draw(){
            frameRate(fps)
            background(0)
            fill(255)
            draw_grid()

            gif_frame_number = (gif_frame_number + 1) % gif_frames.length
        }

    </script>

</body>
</html>